# 压力测试
实现的ocpp压测工具,每个连接使用一个协程的方式来进行模拟，最大限度的利用 CPU 资源

### 用法
- 支持参数:
```
usage of (go build stress.go ***):
  -c uint64
      建立连接数 (default 1)
  -n uint64
      请求数(单个websocket连接每秒请求数) (default 1)
  -u string
      websocket压测地址
  -k  bool
      是否开启长连接测试 (default true)
  -d uint64
      压测时长,时间单位为min (default 1min)
```

- 使用示例:
```
go run stress.go -c 20000 -n 10 -u ws://10.66.0.47:8090 -d 5
```

# 测试记录

### 测试准备
- 服务器准备:
准备2台测试服务器(CPU: 4核 内存: 8G 系统: CentOS 7.6, 1台做测试客户端, 1台做测试服务端)

- 内核优化    

  - 测试服务端内核优化    
    ```
    # 查看系统默认的值
    ulimit -n
    # 临时设置最大打开文件数
    ulimit -n 1040000
    ```
    或者 vim /etc/security/limits.conf 添加
    ```
    # 添加以下参数
    root soft nofile 1040000
    root hard nofile 1040000
    root soft nproc 1040000
    root hard nproc 1040000

    * soft nofile 1040000
    * hard nofile 1040000
    * soft nproc 1040000
    * hard nproc 1040000

    root soft core unlimited
    root hard core unlimited

    * soft core unlimited
    * hard core unlimited
    ```

    由于file-max的值小于limits设置的值会导致系统重启以后无法登录，需要执行下面命令
    ```
    echo 12553500 > /proc/sys/fs/file-max
    ```
    最后重启服务器, ulimit -n命令查看是否生效


        

  - 测试客户端内核优化   
    vim /etc/sysctl.conf 在文件最后添加   
    ``` 
    net.ipv4.ip_local_port_range = 1024 65000
    net.ipv4.tcp_mem = 786432 2097152 3145728
    net.ipv4.tcp_rmem = 4096 4096 16777216
    net.ipv4.tcp_wmem = 4096 4096 16777216
    ```
    然后运行 sysctl -p使得配置生效   

    配置说明
    - net.ipv4.ip_local_port_range 表示TCP/UDP协议允许使用的本s地端口号 范围:1024~65000
    - net.ipv4.tcp_mem 确定TCP栈应该如何反映内存使用,每个值的单位都是内存页(通常是4KB)
      - 第一个值是内存使用的下限
      - 第二个值是内存压力模式开始对缓冲区使用应用压力的上限
      - 第三个值是内存使用的上限,在这个层次上可以将报文丢弃,从而减少对内存的使用
    - net.ipv4.tcp_rmem 为自动调优定义socket使用的内存
      - 第一个值是为socket接收缓冲区分配的最少字节数
      - 第二个值是默认值(该值会被rmem_default覆盖),缓冲区在系统负载不重的情况下可以增长到这个值
      - 第三个值是接收缓冲区空间的最大字节数(该值会被rmem_max覆盖)
    - net.ipv4.tcp_wmem 为自动调优定义socket使用的内存
      - 第一个值是为socket发送缓冲区分配的最少字节数 
      - 第二个值是默认值(该值会被wmem_default覆盖),缓冲区在系统负载不重的情况下可以增长到这个值
      - 第三个值是发送缓冲区空间的最大字节数(该值会被wmem_max覆盖)


### 压测结果

![压测50000 websocket连接](https://github.com/iclay/ocpp/tree/main/ocpp1.6/stress_test/image/50000.png)
  ```
  [root@ocpp-test ~]# ./stress -c 50000 -n 10 -u ws://10.66.0.47:8090 -d 5
     耗时(s)│ 连接数  │请求成功数 │请求失败数 │最长耗时(ms) │最短耗时(ms)      │平均耗时(ms)  │状态码
         1s│       0│         0│         0│        0.00│         0.00│         0.00│
        11s│   50000│    493167│         0│     1396.02│         0.49│       928.18│200:493167
        21s│   50000│   1004587│         0│     1563.31│         0.49│       950.29│200:1004587
        31s│   50000│   1502197│         0│     1579.20│         0.30│       968.77│200:1502197
        41s│   50000│   2001765│         0│     1579.20│         0.30│       976.43│200:2001765
        51s│   50000│   2512740│         0│     1579.20│         0.30│       977.68│200:2512740
        61s│   50000│   3008336│         0│     1600.48│         0.30│       982.11│200:3008336
        71s│   50000│   3512569│         0│     1600.48│         0.30│       983.48│200:3512569
        81s│   50000│   4018981│         0│     1600.48│         0.30│       984.57│200:4018981
        91s│   50000│   4519416│         0│     1625.88│         0.30│       985.73│200:4519416
       101s│   50000│   5015027│         0│     1625.88│         0.30│       987.96│200:5015027
       111s│   50000│   5517420│         0│     1633.96│         0.30│       988.58│200:5517420
       121s│   50000│   6009290│         0│     1633.96│         0.30│       990.89│200:6009290
       131s│   50000│   6505881│         0│     1633.96│         0.30│       992.59│200:6505881
       141s│   50000│   6999660│         0│     1633.96│         0.30│       993.77│200:6999660
       151s│   50000│   7530364│         0│     1633.96│         0.30│       989.23│200:7530364
       161s│   50000│   8030593│         0│     1633.96│         0.30│       990.80│200:8030593
       171s│   50000│   8521575│         0│     1633.96│         0.30│       992.07│200:8521575
       181s│   50000│   9021161│         0│     1633.96│         0.30│       992.59│200:9021161
       191s│   50000│   9530960│         0│     1633.96│         0.30│       992.01│200:9530960
       201s│   50000│  10023076│         0│     1633.96│         0.30│       993.17│200:10023076
       211s│   50000│  10510964│         0│     1633.96│         0.30│       993.47│200:10510964
       221s│   50000│  11001891│         0│     1633.96│         0.30│       993.68│200:11001891
       231s│   50000│  11535463│         0│     1633.96│         0.30│       992.97│200:11535463
       241s│   50000│  12037050│         0│     1647.49│         0.30│       993.35│200:12037050
       251s│   50000│  12536732│         0│     1647.49│         0.30│       993.43│200:12536732
       261s│   50000│  13031567│         0│     1647.49│         0.30│       994.27│200:13031567
       271s│   50000│  13531701│         0│     1647.49│         0.30│       994.33│200:13531701
       281s│   50000│  14048057│         0│     1647.49│         0.30│       993.02│200:14048057
       291s│   50000│  14542784│         0│     1647.49│         0.30│       994.01│200:14542784
       301s│   50000│  15024569│         0│     1647.49│         0.30│       995.11│200:15024569
       305s│   50000│  15082409│         0│     1647.49│         0.30│       995.36│200:15082409

    *************************  结果统计  ****************************
    请求总数: 15082409 总请求时间: 304.523 秒 successNum: 15082409 failureNum: 0
    0-1s内返回成功请求数(13162069)
    1-2s内返回成功请求数(1920340)
    2-3s内返回成功请求数(0)
    大于3s返回成功请求数(0)
    *************************  结果 end   ****************************
  ```

  该次压测模拟了50000个连接，每个连接每秒连续发送10个ocpp心跳包(28个字节)，压测时长为5min，可以粗略计算qps≈50000(15082409/305)
